C51 COMPILER V9.03   CTIMER                                                                10/01/2012 19:13:01 PAGE 1   


C51 COMPILER V9.03, COMPILATION OF MODULE CTIMER
OBJECT MODULE PLACED IN ctimer.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE ctimer.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          /* ----------------------- Platform includes --------------------------------*/
   2          #include "ctimer.h"
   3          #include "ADuC847.h"
   4          
   5          /* ----------------------- Defines ------------------------------------------*/
   6          /* Timer ticks are counted in multiples of 50us. Therefore 20000 ticks are
   7           * one second.
   8           */
   9          #define MB_TIMER_TICKS          ( 20000L )
  10          
  11          /* ----------------------- Static variables ---------------------------------*/
  12          static ULONG   T0_reload;
  13          static ULONG   T0_current;      
  14          static UCHAR   TH0_reload_50us;
  15          static UCHAR   TL0_reload_50us;
  16          
  17          /* ----------------------- Start implementation -----------------------------*/
  18          BOOL initTimer0( USHORT usTim1Timeout50us )
  19          {       
  20   1              BOOL bInitialized     = FALSE;
  21   1              USHORT T0_reload_50us = (SCLK / MB_TIMER_TICKS);
  22   1              T0_reload_50us        = 0xFFFF - T0_reload_50us;
  23   1              TH0_reload_50us       = ((T0_reload_50us >> 8) & 0x00FF);
  24   1              TL0_reload_50us       = T0_reload_50us & 0x00FF;
  25   1              
  26   1              T0_reload  = usTim1Timeout50us;
  27   1              T0_current = T0_reload; 
  28   1      
  29   1              TMOD &= 0xF0;// mode1: 16bit timer
  30   1              TMOD |= 0x01;
  31   1               
  32   1              TR0 = 0;
  33   1              TH0 = TH0_reload_50us;
  34   1              TL0 = TL0_reload_50us;
  35   1          TF0 = 0;
  36   1              TR0 = 0;
  37   1              ET0 = 1; // enable timer0 interrupt
  38   1              bInitialized = TRUE;
  39   1       
  40   1          return bInitialized;
  41   1      }
  42          
  43          void enableTimer0( void )
  44          {
  45   1              TR0 = 0;
  46   1              TF0 = 0; 
  47   1          TH0 = TH0_reload_50us;
  48   1              TL0 = TL0_reload_50us;
  49   1              TR0 = 1;
  50   1      }
  51          
  52          void disableTimer0( void )
  53          {
  54   1              TR0 = 0;
  55   1              TF0 = 0;
C51 COMPILER V9.03   CTIMER                                                                10/01/2012 19:13:01 PAGE 2   

  56   1      }
  57          
  58          void timer0_overflow()
  59          {
  60   1              /* entered every 50us */
  61   1              static UCHAR msec = 20;
  62   1              TR0 = 0;
  63   1              T0_current--;
  64   1              msec--;
  65   1              TH0 = TH0_reload_50us;
  66   1              TL0 = TH0_reload_50us;
  67   1              
  68   1              if (!T0_current) {
  69   2                      // overflow
  70   2                      T0_current = T0_reload;
  71   2                      T0_overflow();
  72   2              }
  73   1              if (!msec) {
  74   2                      /* entered every 1msec */
  75   2                      //P2 ^= 0x01; // debug
  76   2                      //msec = 20;    
  77   2              }
  78   1      
  79   1              /* restart timer */
  80   1              TR0 = 1;
  81   1      }
  82          
  83          void timer0IRQHandler( void ) interrupt 1 using 0
  84          { 
  85   1              timer0_overflow();
  86   1      }
  87          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    176    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     11    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
